-- SCD Type 2 
-- Modeling SCD type 2 
-- using is_active column as an indicator and current_season as a patition key

-- SHOW TABLES FROM jkenney0501
-- jkenney0501.nba_players , jkenney0501.nba_players_scd
-- describe jkenney0501.nba_players_scd


CREATE TABLE jkenney0501.nba_players_scd(
player_name VARCHAR,
is_active BOOLEAN,
start_season INTEGER,
end_season INTEGER,
current_season INTEGER
)

-- format and call out parition
WITH (
format = 'PARQUET',
partitioning = ARRAY['current_season']
)


-- **** one load SCD that loads all at once rather than increment *****

-- 1st CTE captures activity and inactivty by displaying if the player was active last season and is currently active.
WITH lagged AS(
SELECT 
player_name,
CASE WHEN is_active THEN 1 ELSE 0 END AS is_active,
CASE WHEN LAG(is_active, 1) OVER(PARTITION BY player_name ORDER BY current_season) THEN 1 ELSE 0 END AS is_active_last_season,
current_season
FROM jkenney0501.nba_players
WHERE current_season <= 2001 -- doing this for incremental load later on 
),

-- identifies a streak of active last season and current
streaked AS (
SELECT *,
SUM(CASE WHEN is_active <> is_active_last_season THEN 1 ELSE 0 END) OVER(PARTITION BY player_name ORDER BY current_season) AS streak_identifier
FROM lagged
-- WHERE player_name = 'Ben Davis' -- for test purposes
)

-- 40:58 left 
SELECT 
player_name,
MAX(is_active) AS is_active,
MIN(current_season) AS start_season,
MAX(current_season) AS end_season,
2001 AS current_season -- hard code for inc load
FROM streaked 
GROUP BY player_name, streak_identifier